# 基本概念
## 文件系统和文件
文件系统：一种用于**持久性**存储的抽象（说白了就是存在硬盘上）
- 组织，控制，导航，访问，检索数据
- 以文件的形式放在硬盘上

文件：
- 文件系统中的存储的一个单元
- 文件属性：名称，类型，位置，大小等

文件头（块）
- 保存文件的信息

## 文件系统的功能
- 分配文件磁盘空间
	- 管理文件夹
	- 管理空闲空间
	- 分配算法
- 管理文件集合
- 提供的功能
	- 保护

## 文件描述符
- 类型是int
- 文件使用模式
	- 打开文件，返回文件描述符
- 代表文件让应用程序访问和控制
- **打开文件表**内存了文件描述符（就是索引功能）

**文件元数据**
- 文件指针
- 文件打开计数：只有当所有进程都关闭了文件，才可以从打开文件表中移除文件
- 文件磁盘位置
- 访问权限

对于操作系统而言，文件系统是块的集合。
块的大小是扇区大小，4kb

**访问文件的模式**
- 顺序访问
- 随机访问
- 基于内容访问：索引，类似数据库

**文件的内部结构**
- 对操作系统：字节流
- 具体读取文件的结构和内容是应用程序实现

**访问控制**
- **文件访问控制列表**管理：<文件管理，权限>
- 用户，组，所有人
- 读，写，执行

**如何访问共享文件**
- 文件系统的同步互斥机制是怎么实现的

**会话语义**
- 从打开到关闭是一个会话
- 写入内容只有当文件关闭时可见

**锁粒度**
- 文件为粒度
- 文件中不同的块为粒度

## 目录
文件以目录的方式组织：**层次目录**。 方便查找和组织

目录的操作
- 增删改查
- 遍历

挂载 mount：
- 目录的结构
- 把别的文件系统挂载到目录

## 文件别名
文件有不同的名字：
- 硬链接：多个文件项指向同一个文件
- 软链接：快捷方式，文件内容存的另一个文件的路径名

## 文件系统种类
- 磁盘文件系统：存储介质是磁盘，光盘
	- FAT，NTFS
- 数据库文件系统
	- WinFS：没搞成
- 日志文件系统：
	- 记录文件系统的修改/事件
	- 作为文件系统的日志功能
- 网络文件系统：
	- NFS：局域网范围内访问另一台机器的文件
- 分布式文件系统
	- Google的GFS
	- 跨网络：没有单机可靠，延迟高
- 虚拟文件系统：
	- 只是一个接口，访问内核中的数据
	- Linux中的proc：内核信息的展现

# 虚拟文件系统
![](https://i.imgur.com/EGl9Gtv.jpg)
- 操作系统抽象出来的简单接口，屏蔽底层的差异
- 底层上，文件系统可以面向网络，面向存储介质等。需要对不同文件系统进行抽象

文件系统的控制块：卷控制块(superblock):
- 文件系统的详细信息：元数据
	- 块，块大小，空余块，计数，指针

每个文件的控制块：文件控制块（vnode）:
- 文件的详细信息：元数据
	- 许可，拥有者，大小，位置

目录节点（dentry）：
- 每个目录一个
- 将目录数据结构及树形部剧编码成树形数据结构
- 节点指向文件控制块等

卷控制块指向目录，根节点指向文件
内存中先加载控制块

# 数据缓存块
硬盘访问速度很慢：buffer技术
- 预读：预先读取后面的数据块
- 延迟写

总而言之是要尽量减少对硬盘的读写次数

# 打开文件的数据结构
将文件控制块的内容读到内存
存入打开文件表
返回fd（存在打开文件表中）

# 文件分配
文件数据空间的管理，如何分配和管理文件的数据块
我们关注**时间**和**空间**的效率
- 连续
- 链式
- 索引

### 连续分配
- 文件头指定起始块和长度
- 优点：高效的顺序和随机读取
- 缺点：重新写之类的很难

### 链式分配
- 链表块的方式存储，文件头包含了指针
- 优点：创建，增大，缩小很容易
- 缺点：只能顺序访问（虽然物理上不是顺序）

### 索引
- 特定的磁盘块作为索引：索引项指向数据块
- 优点：没有碎片，更改容易
- 缺点：索引占空间，文件又多又小划不来

大文件的索引分配：
- 分级索引

# 空闲空间列表
- 如何管理磁盘中空闲的空间：未被分配的数据块
- 位图：11101001010101010101010101
	- 代表每个扇区是否空闲
	- 160G的硬盘只需要5M内存来存储

# 多磁盘管理RAID